{% extends "layouts/post_layout.html" %}
{% block title %}{{ post.title }} - Nexus Gaming{% endblock %}


{% block post_main %}
<article class="bg-gray-800/60 rounded-2xl p-6">
  <h1 class="text-3xl font-bold">{{ post.title }}</h1>
  <p class="text-gray-400 text-sm mt-1">
    Por {{ post.author }} • {{ post.created|date:"d/m/Y H:i" }}
    {% if post.category %} • <a class="text-emerald-400" href="{% url 'by_category' post.category.slug %}">{{ post.category.name }}</a>{% endif %}
  </p>
  <div class="prose prose-invert max-w-none mt-4">{{ post.body|linebreaks }}</div>

  {% if post.photos.all %}
    <div class="grid md:grid-cols-3 gap-3 mt-4">
      {% for ph in post.photos.all %}
        <figure class="bg-gray-900/60 rounded-xl p-2">
          <img src="{{ ph.image.url }}" alt="{{ ph.caption }}" class="rounded-lg w-full">
          {% if ph.caption %}<figcaption class="text-xs text-gray-400 mt-1">{{ ph.caption }}</figcaption>{% endif %}
        </figure>
      {% endfor %}
    </div>
  {% endif %}
</article>


<section class="mt-6 space-y-4">
  <h2 class="text-xl font-semibold">Comentarios</h2>

  {% if user.is_authenticated %}
    <form method="post" action="{% url 'comment_create' post.slug %}" class="bg-gray-800/60 rounded-xl p-4 space-y-3">
      {% csrf_token %}
      <textarea name="text" rows="3" class="w-full bg-gray-900 rounded-lg p-3" placeholder="Escribe un comentario..."></textarea>
      <button class="px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-black font-semibold">Comentar</button>
    </form>
  {% else %}
    <p class="text-gray-400">Inicia sesión para comentar.</p>
  {% endif %}

  <div class="space-y-3">
    {% for c in post.comments.all %}
      <div class="bg-gray-800/60 rounded-xl p-3">
        <p class="text-sm text-gray-400">{{ c.author }} • {{ c.created|date:"d/m/Y H:i" }}</p>
        <p class="mt-1">{{ c.text|linebreaks }}</p>
        {% if user == c.author or perms.post.delete_comment or perms.post.change_comment %}
          <div class="text-right mt-2 space-x-2">
            <a href="{% url 'comment_update' c.pk %}" class="text-emerald-400 text-sm">Editar</a>
            <a href="{% url 'comment_delete' c.pk %}" class="text-red-400 text-sm">Eliminar</a>
          </div>
        {% endif %}
      </div>
    {% empty %}
      <p class="text-gray-400">Sin comentarios aún.</p>
    {% endfor %}
  </div>
</section>
{% endblock %}

{% block content %}
<section class="relative overflow-hidden bg-gradient-to-b from-slate-950 via-black to-slate-950 text-white">
  <!-- Glow decorativo -->
  <div class="pointer-events-none absolute -top-24 left-1/2 size-[36rem] -translate-x-1/2 rounded-full bg-emerald-500/25 blur-3xl"></div>

  <div class="relative max-w-3xl mx-auto px-4 py-16">
    <div class="text-center">
<h3 class="text-5xl uppercase m-4 font-extrabold">{{ post.title }}</h3>
{% if active_images %}
  <div class="grid grid-cols-1 sm:grid-cols-2  justify-items-center gap-4 ">
    {% for image in active_images %}
    <a href="{{ image.image.url }}" target="_blank">
      <img 
        src="{{ image.image.url }}"
        alt="Portada del post {{ image.id }}"
        class="w-[400px] object-cover aspect-[16/9] rounded-2xl">
    </a>
    {% endfor %}
  </div>
{% endif %}
<p class="m-4 text-xl">{{ post.content }}</p>
<p>Publicado por: <strong class="font-bold">{{ post.author.username }}</strong></p>
<p>Fecha de publicación: {{ post.created_at }}</p>
<p>Comentarios permitidos: {{ post.allow_comments|yesno:"Si,No" }}</p>

<div class="flex mt-8 gap-4 justify-center">
  <a
    class="bg-blue-500 text-white p-2 rounded-lg"
    href="{% url 'post:post_update' slug=post.slug %}"
  >Editar post</a>
  <a
    class="bg-red-500 text-white p-2 rounded-lg"
    href="{% url 'post:post_delete' slug=post.slug %}"
  >Eliminar post</a>
</div>


<h4 class="mt-8 mb-2 font-semibold text-xl">Comentarios:</h4>
{% if post.comments.count %}
  <ul>
    {% for comment in post.comments.all %}
      {% if comment.id == editing_comment_id %}
        <form method="post" action="{% url 'post:comment_update' comment.id %}" class="mb-8">
          {% csrf_token %}
          <p class="flex flex-col mt-4">{{ edit_comment_form.content.label_tag }} {{ edit_comment_form.content }}</p>
          <button type="submit" class="text-blue-500 font-bold mt-1.5">Actualizar</button>
          <a href="{% url 'post:post_detail' post.slug %}" class="text-red-500 font-bold">Cancelar</a>
        </form>
      {% elif comment.id == deleting_comment_id %}
        <form method="post" action="{% url 'post:comment_delete' comment.id %}" class="mb-8">
          {% csrf_token %}
          <p class="flex flex-col mt-4">¿Estás seguro de que desas eliminar este comentario?</p>
          <button type="submit" class="text-blue-500 font-bold">Confirmar</button>
          <a href="{% url 'post:post_detail' post.slug %}" class="text-red-500 font-bold">Cancelar</a>
        </form>
      {% else %}
        <li class="mb-7 flex flex-col">
          <p class="font-semibold mb-2 mt-3">{{ comment.content }}</p>
          <small>Escrito por {{ comment.author.username }} el {{ comment.created_at }}</small>
          
          {% if comment.author == user %}
            <a href="?edit_comment={{ comment.id }}" class="text-blue-500 font-bold">Editar</a>
            <a href="?delete_comment={{ comment.id }}" class="text-red-500 font-bold">Eliminar</a>
          {% elif user.is_collaborator and post.author == user and not comment.author.is_admin and not comment.author.is_superuser or user.is_admin or user.is_superuser or user.is_staff %}
            <a href="?delete_comment={{ comment.id }}" class="text-red-500 font-bold">Eliminar</a>
          {% endif %}
        </li>
      {% endif %}
    {% endfor %}
  </ul>
{% endif %}

{% if user.is_authenticated %}
  <h4 class="font-semibold text-xl">Agregar un comentario</h4>
  <form method="post" action="{% url 'post:comment_create' post.slug %}">
    {% csrf_token %}
    <p class="flex flex-col mt-2 mb-8 rounded-2xl">{{ add_comment_form.content.label_tag }} {{ add_comment_form.content }}</p>
    <button type="submit" class="bg-blue-500 text-white p-2 rounded-lg">Agregar comentario</button>
  </form>
{% else %}
  <p>
    <a href="{% url 'user:auth_login' %}?next={{ request.path }}" class="hover:text-blue-500">Inicia sesión</a>
    para agregar un comentario.
  </p>
{% endif %}

{% endblock content %}
    
    
